version: "3.8"

services:
  postgres:
    image: postgres:15
    container_name: shopware_pg
    restart: always
    environment:
      POSTGRES_USER: shopware
      POSTGRES_PASSWORD: shopware
      POSTGRES_DB: shopware
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5433:5432"

  shopware:
    image: dockware/dev:latest
    container_name: shopware_staging
    restart: always
    ports:
      - "8080:80"
    env_file:
      - .env
    volumes:
      - ./custom/plugins:/var/www/html/custom/plugins
    depends_on:
      - postgres
    environment:
      DATABASE_URL: postgresql://shopware:shopware@postgres:5432/shopware
      APP_ENV: dev
      SHOPWARE_HTTP_CACHE_ENABLED: 0
      PHP_MEMORY_LIMIT: 1G
    command: >
      bash -c "
        composer install &&
        bin/console system:install --basic-setup --force &&
        bin/console plugin:refresh &&
        bin/console plugin:install --activate PastaCleanCarousel &&
        bin/console theme:compile &&
        apache2-foreground
      "

volumes:
  pgdata:
